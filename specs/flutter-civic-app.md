# Nepal Civic Information Flutter App - Specification

## Overview

Build a Flutter app combining:
1. **Constitution Reader** - All features from existing web app
2. **Leaders Directory** - 298 political leaders from ratemyneta.com
3. **Interactive District Map** - SVG map, tap district â†’ show leaders

## Architecture Decisions

### Data Strategy
- **Bundle JSON assets** with app (offline-first)
- **Remote update URL** checked on app launch for newer data
- **Weekly CI job** fetches fresh data, downloads images, updates bundle
- App compares local version with remote, downloads if newer

### Technology
- **Flutter** (cross-platform: Android now, iOS later)
- **State management**: Riverpod (well-documented, agent-friendly patterns)
- **Local storage**: Hive or shared_preferences for user data
- **SVG rendering**: flutter_svg package

---

## Data Files (bundled as assets)

### 1. `assets/data/constitution_bilingual.json`
Existing file - paragraph-level constitution data

### 2. `assets/data/per-sentence.json`
Existing file - sentence-level aligned pairs

### 3. `assets/data/dictionary.json`
Existing file - Nepali-English dictionary

### 4. `assets/data/leaders.json` (NEW - generated by CI)
```json
{
  "version": "2026-01-17",
  "leaders": [
    {
      "_id": "6813e17102896387a7b8c6d7",
      "name": "Balendra Shah",
      "party": "Independent",
      "position": " ",
      "district": "Kathmandu",
      "biography": "...",
      "imageUrl": "assets/images/leaders/6813e17102896387a7b8c6d7.jpg",
      "upvotes": 9740,
      "downvotes": 640,
      "totalVotes": 10380
    }
  ]
}
```

### 5. `assets/data/districts.json` (NEW - mapping)
```json
{
  "jhapa": { "name": "Jhapa", "province": 1 },
  "kathmandu": { "name": "Kathmandu", "province": 3 },
  ... }
```

### 6. `assets/data/parties.json` (NEW - generated by CI)
```json
{
  "parties": [
    {
      "id": "nepali-congress",
      "name": "Nepali Congress",
      "shortName": "NC",
      "color": "#FF0000",
      "leaderCount": 90
    },
    {
      "id": "uml",
      "name": "Nepal Communist Party (UML)",
      "shortName": "UML",
      "color": "#0000FF",
      "leaderCount": 79
    }
  ]
}
```

### 7. `assets/images/nepal_districts.svg`
SVG with labeled district paths (77 districts, province color-coded)
- Districts have IDs: `jhapa`, `kathmandu`, `dolpa`, etc.
- Has hover/tap CSS classes

### 8. Remote update manifest
App checks `https://your-cdn.com/nepal-civic/manifest.json`:
```json
{
  "version": "2026-01-17",
  "leaders_url": "https://your-cdn.com/nepal-civic/leaders.json",
  "leaders_images_url": "https://your-cdn.com/nepal-civic/images/"
}
```

---

## Political Parties (27 total, 298 leaders)

| Party | Leaders |
|-------|---------|
| Nepali Congress | 90 |
| Nepal Communist Party (UML) | 79 |
| Nepal Communist Party (Maoist Center) | 33 |
| Rastriya Swotantra Party | 20 |
| Rastriya Prajatantra Party | 15 |
| Communist Party of Nepal (Unified Socialist) | 11 |
| Independent | 7 |
| People's Socialist Party | 7 |
| Janamat Party | 6 |
| Janata Samajbadi Party Nepal | 6 |
| Loktantrik Samajwadi Party Nepal | 4 |
| Nagarik Unmukti Party | 4 |
| + 15 others with 1-2 leaders each | |

---

## District-Leader Mapping

### District name normalization
API returns inconsistent district names. Normalize during CI:

```json
{
  "district_aliases": {
    "Kapilvastu": "Kapilbastu",
    "Nawalparasi (East of Bardaghat Susta)": "Nawalparasi",
    " ": null
  }
}
```

### SVG ID â†’ District mapping
SVG uses lowercase IDs. Create bidirectional map:
```json
{
  "svg_to_name": {
    "kathmandu": "Kathmandu",
    "jhapa": "Jhapa",
    "nawalparasi (bardaghat susta east)": "Nawalparasi"
  }
}
```

### Leaders per district
- 77 districts in Nepal
- ~79 unique in API (some variants)
- Average ~3.8 leaders per district
- Some districts may have 0 leaders in data

---

## Offline/Sync Strategy

### Initial load
1. App ships with bundled `leaders.json` (version dated)
2. On first launch, copy to app documents directory

### Update check (on app launch, wifi only)
```
1. Fetch manifest.json from CDN
2. Compare version with local
3. If newer:
   a. Show "Update available" banner (non-blocking)
   b. User can tap to download
   c. Download in background
   d. Replace local data on success
4. If offline or error: silently continue with local data
```

### Storage structure
```
/app_documents/
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ leaders.json
â”‚   â””â”€â”€ version.txt
â””â”€â”€ images/
    â””â”€â”€ leaders/
        â””â”€â”€ {id}.jpg
```

### Image caching
- Use `cached_network_image` for leader photos
- Falls back to bundled images if offline
- Clear cache option in settings

---

## UI/UX Design

### Navigation (Bottom Nav)
```
[Constitution]  [Leaders]  [Map]  [Settings]
```

### Screen Flow

```
Home (Constitution)
â”œâ”€â”€ Preamble
â”œâ”€â”€ Part List
â”‚   â””â”€â”€ Part Detail
â”‚       â””â”€â”€ Article Detail
â”‚           â”œâ”€â”€ Notes Editor
â”‚           â””â”€â”€ Bookmarks
â””â”€â”€ Search Results

Leaders
â”œâ”€â”€ All Leaders (grid/list toggle)
â”‚   â””â”€â”€ Leader Detail
â”‚       â””â”€â”€ â†’ Map (district highlight)
â”œâ”€â”€ By Party
â”‚   â””â”€â”€ Party Leaders List
â”‚       â””â”€â”€ Leader Detail
â””â”€â”€ By District
    â””â”€â”€ District Leaders List
        â””â”€â”€ Leader Detail

Map
â”œâ”€â”€ Full Nepal Map
â”‚   â””â”€â”€ Tap District
â”‚       â””â”€â”€ Bottom Sheet (leaders list)
â”‚           â””â”€â”€ Leader Detail
â””â”€â”€ Province filter (optional)

Settings
â”œâ”€â”€ Language preference
â”œâ”€â”€ View mode default
â”œâ”€â”€ Meaning mode toggle
â”œâ”€â”€ Check for updates
â”œâ”€â”€ Clear cache
â””â”€â”€ About
```

### Constitution Screen
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â˜°  Constitution of Nepal   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Both] [à¤¨à¥‡à¤ªà¤¾à¤²à¥€] [English]   â”‚
â”‚ [Paragraph] [Sentence]      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ” Search articles...       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ PREAMBLE               â”‚ â”‚
â”‚ â”‚ à¤ªà¥à¤°à¤¸à¥à¤¤à¤¾à¤µà¤¨à¤¾ / Preamble    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                             â”‚
â”‚ PART 1 - Preliminary        â”‚
â”‚ â”œâ”€â”€ Article 1: Constitution â”‚
â”‚ â”œâ”€â”€ Article 2: Sovereignty  â”‚
â”‚ â””â”€â”€ ...                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Leaders Screen
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Leaders            ğŸ”       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [All] [By Party] [By Dist]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Filter: [Party â–¼] [Dist â–¼]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ ğŸ“·  Balendra Shah      â”‚  â”‚
â”‚ â”‚     Independent        â”‚  â”‚
â”‚ â”‚     Kathmandu  â–²9740   â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ ğŸ“·  Pushpa Kamal Dahal â”‚  â”‚
â”‚ â”‚     Maoist Center      â”‚  â”‚
â”‚ â”‚     Gorkha     â–¼9021   â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Map Screen
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Nepal Districts    [âˆ’] [+]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                             â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    /    Nepal          \    â”‚
â”‚   /   Districts         \   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                             â”‚
â”‚  [Province: All â–¼]          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Tap district to see leaders â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

(On tap: Bottom sheet)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”€â”€â”€ Kathmandu (Province 3)  â”‚
â”‚     3 Leaders               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“· Balendra Shah - Indep.   â”‚
â”‚ ğŸ“· Leader 2 - NC            â”‚
â”‚ ğŸ“· Leader 3 - UML           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### By Party Screen
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† Political Parties         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ”´ Nepali Congress      â”‚ â”‚
â”‚ â”‚    90 leaders           â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ”µ Nepal Communist (UML)â”‚ â”‚
â”‚ â”‚    79 leaders           â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â­ Maoist Center        â”‚ â”‚
â”‚ â”‚    33 leaders           â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## App Structure

```
lib/
â”œâ”€â”€ main.dart
â”œâ”€â”€ app.dart
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ constitution.dart
â”‚   â”œâ”€â”€ leader.dart
â”‚   â”œâ”€â”€ district.dart
â”‚   â””â”€â”€ note.dart
â”œâ”€â”€ providers/
â”‚   â”œâ”€â”€ constitution_provider.dart
â”‚   â”œâ”€â”€ leaders_provider.dart
â”‚   â”œâ”€â”€ settings_provider.dart
â”‚   â””â”€â”€ notes_provider.dart
â”œâ”€â”€ screens/
â”‚   â”œâ”€â”€ home_screen.dart
â”‚   â”œâ”€â”€ constitution/
â”‚   â”‚   â”œâ”€â”€ constitution_screen.dart
â”‚   â”‚   â”œâ”€â”€ article_detail_screen.dart
â”‚   â”‚   â””â”€â”€ preamble_screen.dart
â”‚   â”œâ”€â”€ leaders/
â”‚   â”‚   â”œâ”€â”€ leaders_screen.dart
â”‚   â”‚   â”œâ”€â”€ leader_detail_screen.dart
â”‚   â”‚   â”œâ”€â”€ leaders_by_party_screen.dart
â”‚   â”‚   â””â”€â”€ leaders_by_district_screen.dart
â”‚   â””â”€â”€ map/
â”‚       â””â”€â”€ district_map_screen.dart
â”œâ”€â”€ widgets/
â”‚   â”œâ”€â”€ constitution/
â”‚   â”‚   â”œâ”€â”€ article_card.dart
â”‚   â”‚   â”œâ”€â”€ language_toggle.dart
â”‚   â”‚   â”œâ”€â”€ view_mode_toggle.dart
â”‚   â”‚   â””â”€â”€ meaning_mode_tooltip.dart
â”‚   â”œâ”€â”€ leaders/
â”‚   â”‚   â”œâ”€â”€ leader_card.dart
â”‚   â”‚   â”œâ”€â”€ party_card.dart
â”‚   â”‚   â””â”€â”€ leader_filters.dart
â”‚   â””â”€â”€ map/
â”‚       â”œâ”€â”€ nepal_map.dart
â”‚       â””â”€â”€ district_popup.dart
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ data_service.dart
â”‚   â”œâ”€â”€ update_service.dart
â”‚   â””â”€â”€ storage_service.dart
â””â”€â”€ utils/
    â”œâ”€â”€ nepali_utils.dart
    â””â”€â”€ article_linkifier.dart
```

---

## Features to Implement

### Constitution Module (port from web)

1. **Data display**
   - Preamble (bilingual)
   - 35 Parts with titles
   - 308 Articles with nested subsections
   - Paragraph view and Sentence view modes

2. **Language toggle**
   - Both / à¤¨à¥‡à¤ªà¤¾à¤²à¥€ / English

3. **Search**
   - Filter articles by title/content
   - Highlight matches

4. **Meaning Mode**
   - Long-press Nepali word â†’ show tooltip with translations
   - Uses dictionary.json

5. **Article linking**
   - Auto-linkify "Article 42" / "à¤§à¤¾à¤°à¤¾ à¥ªà¥¨" references
   - Tap to navigate

6. **Zettelkasten features**
   - Notes per article (stored locally)
   - Bookmarks
   - Tags

7. **Deep linking**
   - Share links to specific articles

### Leaders Module (NEW)

1. **Leaders list (All)**
   - Card view with photo, name, party, district
   - Search by name
   - Filter by party, district
   - Sort by: name, votes, district

2. **Leader detail**
   - Full biography (markdown rendered)
   - Photo
   - Vote counts (read-only display, up/down arrows)
   - District link â†’ map
   - Party link â†’ party list

3. **By Party view**
   - List all 27 parties with leader counts
   - Party card shows: name, color/icon, leader count
   - Tap party â†’ show party's leaders
   - Sort by: leader count (default), alphabetical

4. **By District view**
   - List all 77 districts grouped by province
   - District card shows: name, province, leader count
   - Tap district â†’ show district's leaders
   - Link to map view with district highlighted

### District Map Module (NEW)

1. **Interactive SVG map**
   - Render nepal_districts.svg
   - Each district path is tappable

2. **District tap behavior**
   - Show popup/bottom sheet with:
     - District name
     - Province
     - Leader count
     - List of leaders (thumbnails + names)
   - Tap leader â†’ navigate to detail

3. **Visual feedback**
   - Highlight district on tap
   - Color-code by province (already in SVG)

4. **Zoom/pan**
   - Pinch to zoom
   - Pan around map

---

## CI Pipeline (GitHub Actions)

**Schedule**: Every Monday at 00:00 UTC

**Steps**:
1. Fetch all leaders from `https://api.ratemyneta.com/api/leaders`
2. For each leader, fetch detail from `https://api.ratemyneta.com/api/leaders/{id}`
3. Download each leader's image to `images/leaders/{id}.jpg`
4. Update `imageUrl` in JSON to local path
5. Add version timestamp
6. Commit to repo or upload to CDN
7. Update manifest.json with new version

**Script**: `scripts/fetch_leaders.py`

---

## Key Dependencies (pubspec.yaml)

```yaml
dependencies:
  flutter_riverpod: ^2.4.0
  flutter_svg: ^2.0.0
  hive_flutter: ^1.1.0
  flutter_markdown: ^0.6.0
  cached_network_image: ^3.3.0
  go_router: ^12.0.0
```

---

## Verification

1. **Build**: `flutter build apk --debug`
2. **Test on device**: Install APK, verify:
   - Constitution loads and displays
   - Language toggle works
   - Leaders list shows 298 leaders
   - Map renders, districts are tappable
   - Tap Kathmandu â†’ see Balen Shah
3. **Offline test**: Enable airplane mode, verify app works
4. **Update test**: Change manifest version, verify app detects update

---

## Critical Files

- `lib/main.dart` - Entry point
- `lib/screens/map/district_map_screen.dart` - Interactive map
- `lib/widgets/map/nepal_map.dart` - SVG rendering + tap handling
- `lib/services/update_service.dart` - Remote update check
- `scripts/fetch_leaders.py` - CI data fetcher
- `.github/workflows/update-leaders.yml` - Weekly CI job
